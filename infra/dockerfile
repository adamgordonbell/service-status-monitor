# Use AWS Lambda Python base image
FROM public.ecr.aws/lambda/python:3.12

# Set the working directory
WORKDIR /app

# Install libpcap for scapy
RUN yum update -y && \
    yum install -y libpcap-devel && \
    yum clean all

# Install uv
RUN curl -LsSf https://astral.sh/uv/install.sh | sh

# Enable bytecode compilation and copy mode
ENV UV_COMPILE_BYTECODE=1
ENV UV_LINK_MODE=copy

# First, install only dependencies
COPY pyproject.toml uv.lock ./
RUN uv pip install --system -r <(uv pip freeze)

# Now add the rest of your source code
COPY . .

# Create templates directory if it doesn't exist
RUN mkdir -p /app/templates

# Set environment variables
ENV FLASK_APP=scripts/app_server.py
ENV FLASK_ENV=production
ENV FLASK_RUN_PORT=8080

# Copy the handler script that will interface with Lambda
COPY scripts/app_server.py ${LAMBDA_TASK_ROOT}

# Set the CMD to your handler
CMD ["app_server.lambda_handler"]
